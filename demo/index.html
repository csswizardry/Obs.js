<!doctype html>
<html lang=en-gb>
  <meta charset=utf-8>
  <meta name=viewport content="width=device-width, minimum-scale=1.0">

  <!-- Optional config: observe live changes in this demo -->
  <script>window.obs = { config: { observeChanges: true } };</script>

  <script>
    /*! Obs.js 0.2.0 | (c) Harry Roberts, csswizardry.com | MIT */
    ;(()=>{const e=document.currentScript;if((!e||e.src||e.type&&"module"===e.type.toLowerCase())&&!1===/^(localhost|127\.0\.0\.1|::1)$/.test(location.hostname))return void console.warn("[Obs.js] Skipping: must be an inline, classic <script> in <head>.",e?e.src?"src="+e.src:"type="+e.type:"type=module");const i=document.documentElement,{connection:t}=navigator;window.obs=window.obs||{};const a=!0===(window.obs&&window.obs.config||{}).observeChanges,o=()=>{const e=window.obs||{},t="number"==typeof e.downlinkBucket?e.downlinkBucket:null;e.connectionCapability="low"===e.rttCategory&&null!=t&&t>=8?"strong":"high"===e.rttCategory||null!=t&&t<=5?"weak":"moderate";const a=!0===e.dataSaver||!0===e.batteryLow||!0===e.batteryCritical;e.conservationPreference=a?"conserve":"neutral";const o="weak"===e.connectionCapability||!0===e.dataSaver||!0===e.batteryCritical;e.deliveryMode="strong"!==e.connectionCapability||o||a?o?"lite":"cautious":"rich",e.canShowRichMedia="rich"===e.deliveryMode,e.shouldAvoidRichMedia="lite"===e.deliveryMode,["strong","moderate","weak"].forEach(e=>{i.classList.remove(`has-connection-capability-${e}`)}),i.classList.add(`has-connection-capability-${e.connectionCapability}`),["conserve","neutral"].forEach(e=>{i.classList.remove(`has-conservation-preference-${e}`)}),i.classList.add(`has-conservation-preference-${e.conservationPreference}`),["rich","cautious","lite"].forEach(e=>{i.classList.remove(`has-delivery-mode-${e}`)}),i.classList.add(`has-delivery-mode-${e.deliveryMode}`)},n=()=>{if(!t)return;const{saveData:e,rtt:a,downlink:n}=t;window.obs.dataSaver=!!e,i.classList.toggle("has-data-saver",!!e);const s=(e=>Number.isFinite(e)?25*Math.ceil(e/25):null)(a);null!=s&&(window.obs.rttBucket=s);const r=(e=>Number.isFinite(e)?e<75?"low":e<=275?"medium":"high":null)(a);r&&(window.obs.rttCategory=r,["low","medium","high"].forEach(e=>i.classList.remove(`has-latency-${e}`)),i.classList.add(`has-latency-${r}`));const c=(l=n,Number.isFinite(l)?Math.ceil(l):null);var l;if(null!=c){window.obs.downlinkBucket=c;const e=c<=5?"low":c>=8?"high":"medium";window.obs.downlinkCategory=e,["low","medium","high"].forEach(e=>i.classList.remove(`has-bandwidth-${e}`)),i.classList.add(`has-bandwidth-${e}`)}"downlinkMax"in t&&(window.obs.downlinkMax=t.downlinkMax),o()};n(),a&&t&&"function"==typeof t.addEventListener&&t.addEventListener("change",n);const s=e=>{if(!e)return;const{level:t,charging:a}=e,n=Number.isFinite(t)?t<=.05:null;window.obs.batteryCritical=n;const s=Number.isFinite(t)?t<=.2:null;window.obs.batteryLow=s,["critical","low"].forEach(e=>i.classList.remove(`has-battery-${e}`)),s&&i.classList.add("has-battery-low"),n&&i.classList.add("has-battery-critical");const r=!!a;window.obs.batteryCharging=r,i.classList.toggle("has-battery-charging",r),o()};if("getBattery"in navigator&&navigator.getBattery().then(e=>{s(e),a&&"function"==typeof e.addEventListener&&(e.addEventListener("levelchange",()=>s(e)),e.addEventListener("chargingchange",()=>s(e)))}).catch(()=>{}),"deviceMemory"in navigator){const e=Number(navigator.deviceMemory),t=Number.isFinite(e)?e:null;window.obs.ramBucket=t;const a=(r=t,Number.isFinite(r)?r<=1?"very-low":r<=2?"low":r<=4?"medium":"high":null);a&&(window.obs.ramCategory=a,["very-low","low","medium","high"].forEach(e=>i.classList.remove(`has-ram-${e}`)),i.classList.add(`has-ram-${a}`))}var r;if("hardwareConcurrency"in navigator){const e=Number(navigator.hardwareConcurrency),t=Number.isFinite(e)?e:null;window.obs.cpuBucket=t;const a=(e=>Number.isFinite(e)?e<=2?"low":e<=5?"medium":"high":null)(t);a&&(window.obs.cpuCategory=a,["low","medium","high"].forEach(e=>i.classList.remove(`has-cpu-${e}`)),i.classList.add(`has-cpu-${a}`))}(()=>{const e=window.obs||{},t=e.ramCategory,a=e.cpuCategory;let o="moderate";"high"!==t&&"medium"!==t||"high"!==a?("very-low"===t||"low"===t||"low"===a)&&(o="weak"):o="strong",e.deviceCapability=o,["strong","moderate","weak"].forEach(e=>{i.classList.remove(`has-device-capability-${e}`)}),i.classList.add(`has-device-capability-${o}`)})()})();
    //# sourceURL=obs.inline.js
  </script>

  <title>Obs.js demo</title>

  <style>

    :root {
      --fg: #333;
      --bg: #f9f9f9;
      --brand: #f43059;
      --ok: #0a0;
      --warn: #a60;
      --bad: #a00;
    }

    html {
      color: var(--fg);
      background-color: var(--bg);
      font: 1em/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-weight: 400;
    }

    body {
      margin: 2rem auto;
      max-width: 70ch;
      padding: 0 1rem;
    }

    h1, h2 {
      text-wrap: balance;
      color: var(--brand);
    }

    code, kbd, samp, output, pre {
      font-family: "Operator Mono", SFMono-Regular, Inconsolata, Monaco, Consolas, "Andale Mono", "Bitstream Vera Sans Mono", "Courier New", Courier, monospace;
    }

    a {
      color: var(--brand);
      text-decoration: none;
      font-weight: 600;
    }

    a:hover,
    a:active,
    a:focus {
      text-decoration: underline;
    }

    .c-pill {
      display: inline-block;
      border: 1px solid #ccc;
      padding: .15rem .5rem;
      border-radius: 999px;
      margin: .15rem .25rem .15rem 0;
    }

    .u-good {
      background: #e9f6ea;
      border-color: #cfe9d2;
      color: var(--ok);
    }

    .u-warn {
      background: #fff3e0;
      border-color: #ffe0b2;
      color: var(--warn);
    }

    .u-bad {
      background: #fdecea;
      border-color: #f5c6cb;
      color: var(--bad);
    }

  </style>

  <script src="https://www.googletagmanager.com/gtag/js?id=G-DNCL1RY4GT" async crossorigin></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-DNCL1RY4GT');
  </script>





  <h1>Obs.js demo</h1>

  <p><a href=https://github.com/csswizardry/Obs.js>Obs.js</a> uses the Navigator
  and Battery APIs to get contextual information about your users’ connection
  strength and battery status.</p>

  <p>It is built and maintained by <a href=https://csswizardry.com>Harry
    Roberts</a> under the MIT license.</p>

  <p>This page shows the <code>.has-*</code> classes on
  <code>&lt;html&gt;</code> and the current <code>window.obs</code> object.
  Toggle Data Saver, plug/unplug power, or change networks to see updates (where
  supported).</p>

  <h2><code>html.classList</code></h2>

  <div id=classes aria-live=polite></div>

  <h2><code>window.obs</code></h2>

  <pre id=obs aria-live=polite></pre>

  <script>
    // Render helpers
    const byId = id => document.getElementById(id);
    const classesEl = byId('classes');
    const obsEl = byId('obs');

    const interesting = (cls) => cls.startsWith('has-');

    // Map classes to traffic-light colours for quick visual scanning.
    const classify = (name) => {
      // Red (bad)
      if (
        /battery-critical/.test(name) ||
        /latency-high/.test(name) ||
        /bandwidth-low/.test(name) ||
        /ram-very-low/.test(name) ||
        /ram-low/.test(name) ||
        /cpu-low/.test(name) ||
        /connection-capability-weak/.test(name) ||
        /device-capability-weak/.test(name) ||
        /delivery-mode-lite/.test(name)
      ) return 'c-pill u-bad';

      // Yellow (warn)
      if (
        /battery-low/.test(name) ||
        /data-saver/.test(name) ||
        /device-capability-moderate/.test(name) ||
        /ram-medium/.test(name) ||
        /cpu-medium/.test(name) ||
        /bandwidth-medium/.test(name) ||
        /latency-medium/.test(name) ||
        /conservation-preference-conserve/.test(name) ||
        /connection-capability-moderate/.test(name) ||
        /delivery-mode-cautious/.test(name)
      ) return 'c-pill u-warn';

      // Green (good)
      if (
        /connection-capability-strong/.test(name) ||
        /device-capability-strong/.test(name) ||
        /delivery-mode-rich/.test(name) ||
        /bandwidth-high/.test(name) ||
        /ram-high/.test(name) ||
        /cpu-high/.test(name) ||
        /latency-low/.test(name)
      ) return 'c-pill u-good';

      // Neutral
      return 'c-pill';
    };

    function renderClasses() {
      const list = (document.documentElement.className || '')
        .split(/\s+/)
        .filter(Boolean)
        .filter(interesting)
        .sort((a,b)=>a.localeCompare(b));

      if (!list.length) {
        classesEl.innerHTML = '<div>No <code>has-*</code> classes present (APIs may be unavailable).</div>';
        return;
      }

      classesEl.innerHTML = '';
      list.forEach(cls => {
        const span = document.createElement('samp');
        span.className = classify(cls);
        span.textContent = '.' + cls;
        classesEl.appendChild(span);
      });
    }

    function renderObs() {
      try {
        const snapshot = window.obs ? JSON.parse(JSON.stringify(window.obs)) : {};
        obsEl.textContent = JSON.stringify(snapshot, null, 2);
      } catch {
        obsEl.textContent = String(window.obs);
      }
    }

    function renderAll() {
      renderClasses();
      renderObs();
    }

    // Initial paint
    renderAll();

    // Repaint on likely changes (best-effort)
    // If observeChanges=true, Obs.js already listens to connection/battery.
    // Here we just repaint when the microtask queue is free.
    const queueRender = () => Promise.resolve().then(renderAll);

    // Patch minimal hooks so demo repaints when Obs.js updates:
    // (No-op if props don’t change—cheap.)
    ['change', 'levelchange', 'chargingchange'].forEach(evt => {
      // Connection changes (if available)
      if (navigator.connection?.addEventListener && evt === 'change') {
        navigator.connection.addEventListener('change', queueRender, { passive: true });
      }
    });

    // Battery changes (if available)
    if ('getBattery' in navigator) {
      navigator.getBattery().then(b => {
        if (typeof b.addEventListener === 'function') {
          b.addEventListener('levelchange', queueRender);
          b.addEventListener('chargingchange', queueRender);
        }
      }).catch(()=>{ /* no-op */ });
    }

    // Also repaint after a tick to catch initial async battery read
    setTimeout(renderAll, 0);
  </script>
